name: check
on:
    push:
        branches: [main]
        tags:
            - "*"
    pull_request:
        branches: [main]
jobs:
    mac-build:
        runs-on: mac-arm
        env:
            BEARDIST_CACHE_DIR: /tmp/beardist-cache
            FORGEJO_READWRITE_TOKEN: ${{ secrets.FORGEJO_READWRITE_TOKEN }}
            CLICOLOR: 1
            CLICOLOR_FORCE: 1
        steps:
            - name: Check out repository code
              uses: actions/checkout@v4
            - name: Build
              run: |
                  beardist build
    linux-build:
        runs-on: docker
        container:
            image: code.bearcove.cloud/bearcove/beardist:latest
            volumes:
                - /var/persistent-build-storage:/var/persistent-build-storage
            credentials:
                username: "token"
                password: "${{ secrets.BEARCOVE_PULL_PASSWORD }}"
        env:
            BEARDIST_CACHE_DIR: /var/persistent-build-storage/beardist-cache
            FORGEJO_READWRITE_TOKEN: ${{ secrets.FORGEJO_READWRITE_TOKEN }}
            CLICOLOR: 1
            CLICOLOR_FORCE: 1
        steps:
            - name: Check out repository code
              uses: actions/checkout@v4
            - name: Build
              run: |
                  beardist build
    trigger-formula-update:
        needs: [mac-build, linux-build]
        if: startsWith(github.ref, 'refs/tags/')
        runs-on: docker
        container:
            image: code.bearcove.cloud/bearcove/beardist:latest
            volumes:
                - /var/persistent-build-storage:/var/persistent-build-storage
            credentials:
                username: "token"
                password: "${{ secrets.BEARCOVE_PULL_PASSWORD }}"
        env:
            BEARDIST_CACHE_DIR: /var/persistent-build-storage/beardist-cache
            FORGEJO_READWRITE_TOKEN: ${{ secrets.FORGEJO_READWRITE_TOKEN }}
            CLICOLOR: 1
            CLICOLOR_FORCE: 1
        steps:
            - name: Check out repository code
              uses: actions/checkout@v4
            - name: Trigger formula update
              run: |
                  echo "This is where I'd trigger an update!"
